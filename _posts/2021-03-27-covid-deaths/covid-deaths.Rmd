---
title: "COVID-19: death statistics"
description: |
  This post is on the planning and prototyping process for one of the three sub-modules of a Shiny-based Visual Analytics Application project for the course *ISSS608 - Visual Analytics and Applications* offered in SMU MITB.
author: amanda
URL: https://mydatastory.netlify.app
date: 04-11-2021
output:
  distill::distill_article:
    self_contained: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)
```

# Overview

In December 2019, the Coronavirus (COVID-19) has caught the world's attention with the first COVID-19 cases reported in Wuhan, Hubei, China. Since then, the virus has spread like wildfire across the globe, with countries struggling to contain the virus to curb further spread and resurgence.

Experts believe that COVID-19 is less deadly but more infectious than the Severe Acute Respiratory Syndrome (SARS) virus in 2003. Although the number of deaths due to COVID-19 reached a staggering 2.85 million worldwide, its case fatality ratio or rate (defined as the proportion of deaths among a defined population of interest, in this case, the number of COVID-19 cases) is estimated at 1.4% to 3.4%, a far cry from the 9.6% of SARS and 34.3% of the lesser known Middle East Respiratory Syndrome coronavirus (MERS-CoV). Of the 2.85 million deaths, how do countries compare against each other? This assignment aims to visualise the relationships between health, economic and population structure indicators with COVID-19 deaths across countries.

# Literature review of current visualisations on COVID-19 deaths

Most visualisations report the death toll by location using geo-spatial, time-series and/or in tabular form (see Figure 1).

![Figure 1: Current visualisations on COVID-19 deaths.<br>*(a)* Choropleth map of cumulative confirmed deaths per million people.<br>Source: https://ourworldindata.org/covid-deaths <br>*(b)* Proportional symbol map showing the case fatality ratio by location. Actual numbers are reported on the right side panel.<br>Source: https://coronavirus.jhu.edu/map.html <br>*(c)* Time-series of cumulative confirmed deaths per million people. Countries can be added or removed.<br>Source: https://ourworldindata.org/covid-deaths <br>*(d)* Table with horizontal bar charts and another time-series visualisation on the deaths reported per day.<br>Source: https://pandemic.internationalsos.com/2019-ncov/covid-19-data-visualisation](images/currviz.jpg)

These visualisations focus on comparing countries based on the number of deaths or case fatality rates. Comparisons are made based on visual encodings such as colour and size of data points. When used appropriately, users are able to perceive the information effectively (Figure 1-a to c). We can see that there is a lot of visual clutter when more countries are added, as seen in the time-series graph in Figure 1-d.

More details on number of deaths for individual countries are also provided via interactivity in some visualisations (see Figure 1-c for example). However, the comparisons are limited to the countries selected and it could be challenging to make comparisons when more countries are added. On the other hand, the table provides a single-view of the details across countries in descending order, but the numbers could be overwhelming for users to process even with the horizontal bar charts. Furthermore, a tabular layout makes it difficult to compare specific countries of interest.

There are lesser analyses that compare deaths or case fatality with other indicators. Some analyses study the impact of COVID-19 on the indicators while others study the impact of the indicators on the COVID-19 numbers. The review will focus on the analysis or visualisations used, which can potentially be employed to both types of analyses.

#### Scatterplot of economic indicators against number of deaths per million

![Figure 2: Scatterplot on change in GDP per capita against deaths per million.<br>Source: https://theconversation.com/data-from-45-countries-show-containing-covid-vs-saving-the-economy-is-a-false-dichotomy-150533](images/currscatterplot.jpg)

The scatterplot is useful in showing the relationship between two independent variables. In this scatterplot, size and colour scales are used to encode number of deaths and continent respectively. The size of the data points are not obvious from the graph due to the size range used, the 3-character country code labels and the choice of colour for Europe (the green stands out too much). The overlap in data points belonging to the same continent also make it difficult to identify the data points. There is no interactivity in this visualisation.

#### Funnel plot of case fatality rate against number of confirmed cases

There are two similar visualisations created specifically for COVID-19 case fatality rate for counties in the US by a SAS researcher Rick Wicklin (see Figure 3). Unlike the time-series, geo-spatial and tabular visualisations where users make comparisons based on the face-value of the numbers, the funnel plot seeks to highlight any anomalies from the expected range of the numerical values based on statistical concepts. Note that the factors plotted on a funnel plot are dependent on each other, i.e. the number of confirmed cases is used to calculate the case fatality rate.

![Figure 3: Funnel plot on case fatality rate against number of confirmed cases.<br>Source: https://blogs.sas.com/content/iml/2020/04/22/funnel-plot-covid-us.html](images/currfunnelplot.jpg)

The drawback of the visualisations is that the funnel plots are static with no interactivity: users are unable to identify the other data points that are not labelled by the author.

#### Tabular presentation of correlation index between socio-economic indicators and number of deaths per million

The study "Rich at risk: socio-economic drivers of COVID-19 pandemic spread" by Gangemi, S., Billeci, L. & Tonacci, A. (2020) seeks to understand the spread of the COVID-19 virus driven by socio-economic factors and long-distance transportations. The results are presented in a table (see Figure 4). Although the presentation of the results are not visually appealing, this study sheds light on the current analysis performed for COVID-19 deaths. 

![Figure 4: Table of correlations between socio-economic indicators and number of cases per million and number of deaths per million.<br>Source: https://clinicalmolecularallergy.biomedcentral.com/articles/10.1186/s12948-020-00127-4](images/currcorr.jpg)

#### Scatterplot with fit line and regression model summary table to predict number of new deaths

The visualisations discussed thus far are bivariate in nature: analysis of each factor with the number of deaths. There are very few multivariate analysis done, and of those conducted, most of them are presented in tabular form or described in text. There is one study on regression models to predict the number of COVID-19 new deaths, which presents its findings visually in the research paper (see Figure 5).

![Figure 5: *(Left)* Table showing the regression models summaries and parameter estimates to predict new COVID-19 deaths. *(Right)* Scatterplot with fit lines comparing the regression models built to predict new COVID-19 deaths by day.<br>Source: https://www.medrxiv.org/content/10.1101/2020.09.04.20188094v1.full.pdf](images/currMLR.jpg)

Although the intention of the assignment is an exploratory analysis, we can still gain some insights from the visualisation used in this predictive regression analysis. It is noted that the regression models built are to predict the number of new deaths by day for a particular location, Ethiopia, solely based on COVID-19 related indicators. The scatterplot with fit lines allows users to visually compare the different regression models built. There is no interactivity in this graph as it is used for reporting purposes.

# Suggested visualisations and R packages

There are gaps in the current visualisations in supporting the intended analysis of this assignment. The majority of interactive visualisations are univariate presented on maps or in time series, while the bivariate and multivariate analysis of the country indicators and the number of deaths are largely static.

In this assignment, we will attempt to create interactive visualisations for bivariate (scatterplot and funnel plot) and multivariate analysis (multiple linear regression) of the number of deaths due to COVID-19 with selected health-socio-economic indicators across countries.

The following R packages will be explored:

| Visualisation | Packages |
|---------------|----------|
| Scatterplot   | *ggplot*, *ggstatsplot*, *car* |
| Funnel Plot   | *ggplot*, *FunnelPlotR*, *metafor*, *metaviz*, *funnelR* |
| Multivariate Analysis | *mlr*, *olsrr* |
| Interactivity | *plotly*, *ggvis* |

# Data Preparation

All data extraction and wrangling are done in R using the *tidyverse* suite of packages. 

## Install and load all necessary packages

```{r}
packages = c('tidyverse', 'UpSetR', 'visdat', 'naniar',
             'ggstatsplot', 'car',
             'FunnelPlotR', 'metafor', 'metaviz', 'funnelR',
             'mlr', 'olsrr',
             'plotly', 'ggvis')
for(p in packages){
  if(!require(p, character.only = T)){
  install.packages(p)
  }
  library(p, character.only = T)
}
```

## Import and extract relevant data

Data by country is obtained from various sources, as shown in the following table:

| <img width=200> Data source | <img width=350> Data |
|-------------|------|
| Our World in Data (owid) | COVID-19 tests, positive rates, country to latitude-longitude coordinates mapping |
| John Hopkins University (JHU) | COVID-19 cases, deaths |
| World Bank | Population age structure, GDP per capita, poverty indicator |
| UNdata | Health expenditure, healthcare facilities and capacity indicators |
| United Nations Development Programme (UNDP) | Human Development Index (HDI), international inbound tourists |

The data is stored across eight files and ```read_csv()``` is used to import and extract the relevant columns from each file into R.

```{r warning=FALSE}
covid <- read_csv("./data/owid-covid-latest.csv",
                         col_types = cols_only(
                           "iso_code" = "c",
                           "continent" = "c",
                           "location" = "c",
                           "last_updated_date" = "D",
                           "total_cases" = "n",
                           "total_deaths" = "n",
                           "total_tests" = "n",
                           "positive_rate" = "n",
                           "test_units" = "c",
                           "population" = "n",
                           "population_density" = "n",
                           "gdp_per_capita" = "n",
                           "extreme_poverty" = "n",
                           "handwashing_facilities" = "n",
                           "hospital_beds_per_thousand" = "n",
                           "human_development_index" = "n"),
                         locale = locale(date_format = "%Y-%m-%d")
                         )

health_exp <- read_csv("./data/UNdata_HealthExpenditure.csv",
                       skip = 2,
                       col_names = c("region/country/area","year_exp","series","percentage"),
                       col_types = "_cncn__")

health_personnel <- read_csv("./data/UNdata_HealthPersonnel.csv",
                       skip = 2,
                       col_names = c("region/country/area","year_personnel","series","value"),
                       col_types = "_cncn__")

pop_prop <- list.files(path="./data/", pattern="WorldBank_PopProp_", full.names = TRUE) %>%
  map_df(~read_csv(.,
                   skip = 4,
                   col_types = cols_only(
                     "Country Name" = "c",
                     "Indicator Name" = "c",
                     "2019" = "n")
                   )
         )

intl_tourists <- read_csv("./data/UNDP_Intl_inbound_tourists_(thousands).csv",
                          skip = 6,
                          col_types = "_c________________________n_",
                          na = c("..")
                          )

geo_lookup <- read_csv("./data/UID_ISO_FIPS_LookUp_Table.csv",
                       col_types = "c_c_____nn__") %>%
  filter(nchar(UID) <= 3) %>%
  select(iso3, Lat, Long_) %>%
  rename("lat" = "Lat", "long" = "Long_")
```

## Wrangle and combine the data

Before combining the data frames into one main data frame for analysis, we need to explore and prepare each data frame.

```{r}
pop_prop_cleaned <- pivot_wider(pop_prop, names_from = "Indicator Name", values_from = "2019") %>%
  rename("0_to_14(%)" = "Population ages 0-14 (% of total population)",
         "15_to_64(%)" = "Population ages 15-64 (% of total population)",
         "65_and_above(%)" = "Population ages 65 and above (% of total population)")
```

```{r}
intl_tourists_cleaned <- rename(intl_tourists,
                        "annual_intl_arrivals_thousands" = "2011-2018")
```

```{r}
health_personnel_phy <- health_personnel %>%
  group_by(`region/country/area`, `series`) %>%
  slice(which.max(`year_personnel`)) %>%
  filter(`series` == "Health personnel: Physicians (per 1000 population)") %>%
  pivot_wider(names_from = "series", values_from = "value") %>%
  rename("num_physicians_per_thousand" = "Health personnel: Physicians (per 1000 population)")
```

```{r}
health_exp_cleaned <- health_exp %>%
  group_by(`region/country/area`, `series`) %>%
  slice(which.max(`year_exp`)) %>%
  pivot_wider(names_from = "series", values_from = "percentage") %>%
  rename("current_health_exp_%gdp" = "Current health expenditure (% of GDP)",
         "domestic_govt_health_exp_%totalgovtexp" = "Domestic general government health expenditure (% of total government expenditure)")
```

After cleaning the individual data frames, we can now combine and store the data in a single data frame.

```{r}
covid_deaths <- covid %>%
  left_join(pop_prop_cleaned, by = c("location" = "Country Name")) %>%
  left_join(intl_tourists_cleaned, by=c("location" = "Country")) %>%
  left_join(health_personnel_phy, by=c("location" = "region/country/area")) %>%
  left_join(health_exp_cleaned, by=c("location" = "region/country/area")) %>%
  left_join(geo_lookup, by=c("iso_code" = "iso3")) %>%
  filter(!is.na(continent))
```

We will reorder the columns to group similar variables.

```{r}
col_order <- c("iso_code", "continent", "location", "last_updated_date",
               "total_cases", "total_deaths", "total_tests", "positive_rate",
               "hospital_beds_per_thousand", "num_physicians_per_thousand",
               "year_personnel", "handwashing_facilities",
               "gdp_per_capita", "current_health_exp_%gdp", "domestic_govt_health_exp_%totalgovtexp",
               "population", "population_density", "0_to_14(%)", "15_to_64(%)", "65_and_above(%)",
               "extreme_poverty", "human_development_index",
               "annual_intl_arrivals_thousands",
               "lat", "long")

covid_deaths <- covid_deaths[, col_order]

glimpse(covid_deaths)
```

## Check the data for missing values

```{r}
missing_values <- covid_deaths %>%
  gather(key = "key", value = "val") %>%
  mutate(isna = is.na(val)) %>%
  group_by(key) %>%
  mutate(total = n()) %>%
  group_by(key, total, isna) %>%
  summarise(num.isna = n()) %>%
  mutate(pct = num.isna / total * 100)

levels <- (missing_values %>% filter(isna == TRUE) %>%
             arrange(pct))$key

percentage_plot <- missing_values %>%
  ggplot() +
    geom_bar(aes(x = reorder(key, pct), y = pct, fill=isna),
             stat = "identity",
             alpha=0.8) +
    scale_x_discrete(limits = levels) +
    scale_fill_manual(name = "",
                      values = c("lightblue","rosybrown"),
                      labels = c("Present", "Missing")) +
    coord_flip() +
    labs(title = "Percentage of missing values", x = 'Variable', y = "% of missing values")

percentage_plot
```
```{r}
vis_miss(covid_deaths)
```



```{r}
gg_miss_upset(covid_deaths, nsets = n_var_miss(covid_deaths), nintersects = NA)
```






# Prototype


```{r warning=FALSE}
ggplot(covid_deaths, aes(x=total_cases, y=total_deaths, colour = continent)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  theme(legend.position = "none")
```

# Storyboard
